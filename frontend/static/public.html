<!doctype html>
<html>
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Public Broadcast</title>
  <style>
    body{font-family: Arial;padding:16px;background:#f6f8fb}
    .card{max-width:900px;margin:16px auto;background:#fff;padding:16px;border-radius:10px}
    .chat{height:300px;overflow:auto;border:1px solid #eee;padding:8px;border-radius:8px;background:#fafafa}
    input,button{padding:10px;margin-top:8px;width:100%;box-sizing:border-box}
    .key{font-weight:700;color:#0b74ff}
  </style>
</head>
<body>
  <div class="card">
    <h2>Public Broadcast</h2>
    <div id="chat" class="chat"></div>
    <input id="msg" placeholder="Say something public">
    <button id="send">Send Public</button>
    <hr>
    <p>Your private entry key (share this with people you want to let into your private room):</p>
    <div id="entryKey" class="key"></div>
    <button id="saveKey">Use this key (go to private)</button>
  </div>

  <script src="https://cdn.socket.io/4.7.1/socket.io.min.js"></script>
  <script src="shared.js"></script>
  <script>
    token = localStorage.getItem('token');
    myId = localStorage.getItem('userId');
    if (!token) location.href = 'login.html';

    const socket = io(API_BASE, { path: '/socket.io' });
    const chat = document.getElementById('chat');
    const entryKey = Math.random().toString(36).slice(2,8);
    document.getElementById('entryKey').innerText = entryKey;

    socket.on('connect', () => socket.emit('auth', token));
    socket.on('public-message', (m) => {
      const p = document.createElement('div');
      p.textContent = m.from + ': ' + m.text;
      chat.appendChild(p);
      chat.scrollTop = chat.scrollHeight;
    });

    document.getElementById('send').onclick = () => {
      const v = document.getElementById('msg').value;
      if (!v) return;
      socket.emit('public-message', v);
      document.getElementById('msg').value = '';
    };

    document.getElementById('saveKey').onclick = async () => {
      // register the key server-side (optional)
      await api('entrykey','POST',{ key: entryKey });
      localStorage.setItem('entryKey', entryKey);
      window.location = 'private.html';
    };
  </script>
</body>
</html>
